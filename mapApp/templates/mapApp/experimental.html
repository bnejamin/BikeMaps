{% extends "mapApp/base.html" %}
{% load staticfiles %}
{% load geojson_tags %}

{% block title %}
Experimental charting
{% endblock %}


{% block headerCSS %}
  <!-- Load leaflet -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.css" />
  <!-- font-awesome icons -->
  <link rel="stylesheet" href="{% static 'leaflet/plugins/awesome-markers/dist/leaflet.awesome-markers.css' %}">
  <!-- Local styles -->
  <style media="screen">
  svg {
    width: 100%;
    height: 100%;
  }
  path.slice{
    stroke-width:2px;
  }
  polyline{
    opacity: .3;
    stroke: black;
    stroke-width: 2px;
    fill: none;
  }
  </style>
{% endblock %}


{% block headerJS %}
<!-- d3 v3.4.8 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.2/d3.min.js" charset="utf-8"></script>
<!-- moment.js date library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.8.4/moment.min.js"></script>
<!-- Load leaflet -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.js"></script>
<!-- Awesome markers -->
<script type="text/javascript" src="{% static 'leaflet/plugins/awesome-markers/dist/leaflet.awesome-markers.min.js' %}" charset="UTF-8"></script>
<!-- Icon definitions -->
<script src="{% static 'mapApp/js/icons.js' %}" charset="utf-8"></script>
{% endblock %}


{% block body %}
  <!-- D3 parallel coords chart -->
  <script charset="utf-8">
    var dataset = [
      {
          "name": "Collisions",
          "count": {{ collisions|length }},
          "color": getColor("collision"),
      },{
          "name": "Near misses",
          "count": {{ nearmisses|length }},
          "color": getColor("nearmiss"),
      },{
          "name": "Hazards",
          "count": {{ hazards|length }},
          "color": getColor("hazard"),
      },{
          "name": "Thefts",
          "count": {{ thefts|length }},
          "color": getColor("theft"),
      },
    ]

    var svg = d3.select("body")
      .append("svg")
      .append("g");

    svg.append("g")
    	.attr("class", "slices");
    svg.append("g")
    	.attr("class", "labels");
    svg.append("g")
    	.attr("class", "lines");

    var width = 960,
      height = 450,
    	radius = Math.min(width, height) / 2;

    var pie = d3.layout.pie()
      .sort(null)
      .value(function(d){ return d.count; });

    var arc = d3.svg.arc()
    	.outerRadius(radius * 0.8)
    	.innerRadius(radius * 0.4);

    var outerArc = d3.svg.arc()
    	.innerRadius(radius * 0.9)
    	.outerRadius(radius * 0.9);

    svg.attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

    var key = function(d){ return d.data.name; };


    /* ------- PIE SLICES -------*/
  	var slice = svg.select(".slices").selectAll("path.slice")
  		.data(pie(dataset), key);

  	slice.enter()
  		.insert("path")
  		.style("fill", function(d) { return d.data.color; })
  		.attr("class", "slice");

    slice
  		.attr("d", function(d) {
  			return arc(d);
  		});


    /* ------- TEXT LABELS -------*/
  	var text = svg.select(".labels").selectAll("text")
  		.data(pie(dataset), key);

  	text.enter()
  		.append("text")
  		.attr("dy", ".35em")
  		.text(function(d) {
  			return d.data.name;
  		});

  	function midAngle(d){
  		return d.startAngle + (d.endAngle - d.startAngle)/2;
  	}

  	text
  		.attr("transform", function(d) {
  				var pos = outerArc.centroid(d);
  				pos[0] = radius * (midAngle(d) < Math.PI ? 1 : -1);
  				return "translate("+ pos +")";
  		})
  		.style("text-anchor", function(d){
  				return midAngle(d) < Math.PI ? "start":"end";
  		});

    /* ------- SLICE TO TEXT POLYLINES -------*/
  	var polyline = svg.select(".lines").selectAll("polyline")
  		.data(pie(dataset), key);

  	polyline.enter()
  		.append("polyline");

  	polyline
  		.attr("points", function(d){
  				var pos = outerArc.centroid(d);
  				pos[0] = radius * 0.95 * (midAngle(d) < Math.PI ? 1 : -1);
  				return [arc.centroid(d), outerArc.centroid(d), pos];
  		});

  </script>
{% endblock %}
