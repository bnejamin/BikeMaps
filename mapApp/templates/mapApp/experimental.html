{% extends "mapApp/base.html" %}
{% load staticfiles %}
{% load geojson_tags %}

{% block title %}
Experimental charting
{% endblock %}


{% block headerCSS %}
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.css">
  <link rel="stylesheet" href="{% static 'leaflet/plugins/awesome-markers/dist/leaflet.awesome-markers.css' %}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dc/1.7.3/dc.css">
  <style>
    #map{
      height: 100%
    }
  </style>

{% endblock %}

{% block body %}
  <div class="container" style="margin-top: 15px;">
    <!-- <div class="row">
      <!-- <div class="col-xs-8" style="height: 400px;">
        <div id="map"></div>
        <div id="scatter" class="text-center">
          <strong>Title</strong>
          <a class='reset' href='javascript:scatter.filterAll();dc.redrawAll();' style='display: none;'>reset</a>
        </div>
      </div> -->

    <div class="row">
      <div class="col-xs-4">
        <div id="pieTypes" class="text-center">
          <strong>Total Number of reports</strong>
          <a class='reset' href='javascript:pieTypes.filterAll();dc.redrawAll();' style='display: none;'>reset</a>
          <br>
        </div>
      </div>

      <div class="col-xs-8">
        <div id="barWeek" class="text-center">
          <strong>Reports Summary by Weekday</strong>
          <a class='reset' href='javascript:barWeek.filterAll();dc.redrawAll();' style='display: none;'>reset</a>
          <br>
        </div>
      </div>

      <div class="col-xs-12">
        <div id="barDate" class="text-center">
            <strong>Incidents Per Day for the Past Year</strong>
            <a class='reset' href='javascript:barDate.filterAll();dc.redrawAll();' style='display: none;'>reset</a>
            <br>
        </div>
      </div>
      <a class='reset' href='javascript:dc.filterAll();dc.renderAll();'>reset all</a>
    </div>
  </div>


{% endblock %}

{% block footerJS %}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.2/d3.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crossfilter/1.3.11/crossfilter.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dc/1.7.3/dc.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.8.4/moment.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.js"></script>
  <script src="{% static 'leaflet/plugins/awesome-markers/dist/leaflet.awesome-markers.min.js' %}"></script>
  <script src="{% static 'mapApp/js/map.js' %}"></script>
  <script src="{% static 'mapApp/js/icons.js' %}"></script>

  <script>
    var collisions = {{ collisions|geojsonfeature:"report_date,date,p_type,i_type"|safe}}['features'];
    var nearmisses = {{ nearmisses|geojsonfeature:"report_date,date,p_type,i_type"|safe}}['features'];
    var hazards = {{ hazards|geojsonfeature:"report_date,date,p_type,i_type"|safe}}['features'];
    var thefts = {{ thefts|geojsonfeature:"report_date,date,p_type,i_type"|safe}}['features'];

    var data = collisions.concat(nearmisses).concat(hazards).concat(thefts);


    // map p_types of points to nice labels
    var labels = {
      "collision": "Collisions",
      "nearmiss": "Nearmisses",
      "hazard": "Hazards",
      "theft": "Thefts",
    }
    // Define scales
    // map p_type to appropriate colors
    var colorScale = d3.scale.ordinal()
      .domain(["collision", "nearmiss", "hazard", "theft"])
      .range([iconColors.collision, iconColors.nearmiss, iconColors.hazard, iconColors.theft]);

    var weekdayScale = d3.scale.quantize()
        .domain([0,1,2,3,4,5,6])
        .range(moment.weekdays());

    // Define charts
    var pieTypes = dc.pieChart("#pieTypes");
    var barWeek = dc.barChart("#barWeek");
    var barDate = dc.barChart("#barDate");

    // Define crossfilter dataset
    var xf = crossfilter(data);

    // Define dimensions
    var p_typeDimension = xf.dimension(function(d) {return d['properties']['p_type'];}),
        weekdayDimension = xf.dimension(function(d) {return (moment(d['properties']['date']).weekday()+6)%7 }),
        dateDimension = xf.dimension(function(d){ return moment(d.properties.date).diff(moment(), "days"); });

    // Define groups
    var countTypes = p_typeDimension.group().reduceCount(),
        weekdayCount = weekdayDimension.group().reduce(
          function (p,v) {
            var p_type = v.properties.p_type;
            if(p_type === "collision") p.collision++;
            else if(p_type === "nearmiss") p.nearmiss++;
            else if(p_type === "hazard") p.hazard++;
            else if(p_type === "theft") p.theft++;
            return p;
          },
          function (p,v) {
            var p_type = v.properties.p_type;
            if(p_type === "collision") p.collision--;
            else if(p_type === "nearmiss") p.nearmiss--;
            else if(p_type === "hazard") p.hazard--;
            else if(p_type === "theft") p.theft--;
            return p;
          },
          function () {
            return {
              collision: 0,
              nearmiss: 0,
              hazard: 0,
              theft: 0
            };
          }
        ),
        countPerDay = dateDimension.group().reduce(
          function (p,v) {
            var p_type = v.properties.p_type;
            if(p_type === "collision") p.collision++;
            else if(p_type === "nearmiss") p.nearmiss++;
            else if(p_type === "hazard") p.hazard++;
            else if(p_type === "theft") p.theft++;
            return p;
          },
          function (p,v) {
            var p_type = v.properties.p_type;
            if(p_type === "collision") p.collision--;
            else if(p_type === "nearmiss") p.nearmiss--;
            else if(p_type === "hazard") p.hazard--;
            else if(p_type === "theft") p.theft--;
            return p;
          },
          function () {
            return {
              collision: 0,
              nearmiss: 0,
              hazard: 0,
              theft: 0
            };
          }
        );

    // Pie chart for number of each type of report
    pieTypes
      .width(300)
      .height(300)
      // .innerRadius(50)
      .dimension(p_typeDimension)
      .group(countTypes)
      .ordering(function(d){ return -d.value })
      .label(function(d){return labels[d.data.key];})
      .colors(colorScale.range())
      .colorAccessor(function(d){return colorScale.domain().indexOf(d.data.key);});

    pieTypes.render();

    // Bar chart for reports this week
    barWeek
      .width(700)
      .height(300)
      .x(d3.scale.linear().domain([-0.5,6.5]))
      .yAxisLabel("Count")
      .centerBar(true)
      .elasticY(true)
      .dimension(weekdayDimension)
      .group(weekdayCount, "Collisions").valueAccessor(function(d){return d.value.collision; })
      .stack(weekdayCount, "Nearmisses", function(d){ return d.value.nearmiss; })
      .stack(weekdayCount, "Hazards", function(d){ return d.value.hazard; })
      .stack(weekdayCount, "Thefts", function(d){ return d.value.theft; })
      .brushOn(true)
      .colors(colorScale.range())
      .colorAccessor(function(d){return d.layer;});

    barWeek.yAxis().tickFormat(d3.format("d"));
    barWeek.xAxis().tickValues([0,1,2,3,4,5,6]);
    barWeek.xAxis().tickFormat(function(v){ return weekdayScale((v+1)%7); });
    barWeek.render();

    // bar chart of total reports per day
    barDate
      .width(1000)
      .height(175)
      .x(d3.scale.linear().domain([-360, 0]))
      .yAxisLabel("Count")
      .centerBar(true)
      .elasticY(true)
      .dimension(dateDimension)
      .group(countPerDay, "Collisions").valueAccessor(function(d){return d.value.collision; })
      .stack(countPerDay, "Nearmisses", function(d){ return d.value.nearmiss; })
      .stack(countPerDay, "Hazards", function(d){ return d.value.hazard; })
      .stack(countPerDay, "Thefts", function(d){ return d.value.theft; })
      .brushOn(true)
      .colors(colorScale.range())
      .colorAccessor(function(d){return d.layer;});

    barDate.yAxis().tickFormat(d3.format("d"));
    barDate.xAxis().tickFormat(function(v){ return moment().add(v, "days").format("MMM. D"); });
    // barDate.xAxis().tickValues(); //TODO make first of each month?
    barDate.render();

    // bar chart of delay in reporting


    // Leaflet heatmap
    // var map = L.map('map', {
    //   center: [51.505, -0.09],
    //   zoom: 13,
    //   layers: [MapQuestOpen_OSM]
    // });

    // geometryGroup = p_typeDimension.group().reduce(
    //   function(p,v){
    //     // console.log(v);
    //     p.push(v.geometry.coordinates.join());
    //     return p;
    //   },
    //   function(p,v){
    //     console.log(v);
    //     var i = p.indexOf(v.geometry.coords.join());
    //     console.log(i);
    //     if (i > -1)
    //       p.splice(i, 1);
    //     return p;
    //   },
    //   function(){
    //     return [];
    //   }
    // );

    // TODO
    // More charts..
    // Create new js file for dc script

    dc.renderAll();
    dc.redrawAll();
  </script>

{% endblock %}
