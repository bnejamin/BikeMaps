{% extends "mapApp/base.html" %}
{% load staticfiles %}
{% load geojson_tags %}

{% block title %}
Experimental charting
{% endblock %}


{% block headerCSS %}
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.css">
  <link rel="stylesheet" href="{% static 'leaflet/plugins/awesome-markers/dist/leaflet.awesome-markers.css' %}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dc/1.7.3/dc.css">
  <style>
    #map{
      height: 100%
    }
  </style>

{% endblock %}

{% block body %}
  <div class="container" style="margin-top: 15px;">
    <div class="row">
      <div class="col-xs-8" style="height: 400px;">
        <div id="map"></div>
      </div>

      <div class="col-dxs-4">
        <div id="pieTypes" class="text-center">
          <strong>Total number of reports</strong>
          <a class='reset' href='javascript:pieTypes.filterAll();dc.redrawAll();' style='display: none;'>reset</a>
          <br>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-xs-8">
        <div id="barWeek" class="text-center">
          <strong>Reports summary by weekday</strong>
          <a class='reset' href='javascript:barWeek.filterAll();dc.redrawAll();' style='display: none;'>reset</a>
          <br>
        </div>
      </div>

      <div class="col-xs-12">
        <div id="barDate" class="text-center">
            <strong>Incidents per day for the past year</strong>
            <a class='reset' href='javascript:barDate.filterAll();dc.redrawAll();' style='display: none;'>reset</a>
            <br>
        </div>
      </div>
    </div>

      <div class="col-xs-6">
        <div id="delayRows" class="text-center">
            <strong>Average days of delay before incident reported by report type</strong>
            <a class='reset' href='javascript:delayRows.filterAll();dc.redrawAll();' style='display: none;'>reset</a>
            <br>
        </div>
      </div>



      <a class='reset' href='javascript:dc.filterAll();dc.renderAll();'>reset all</a>
  </div>


{% endblock %}

{% block footerJS %}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.2/d3.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crossfilter/1.3.11/crossfilter.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dc/1.7.3/dc.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.8.4/moment.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.js"></script>
  <script src="{% static 'leaflet/plugins/leaflet-heatmap/heatmap.min.js' %}"></script>
  <script src="{% static 'leaflet/plugins/leaflet-heatmap/leaflet-heatmap.js' %}"></script>
  <script src="{% static 'leaflet/plugins/awesome-markers/dist/leaflet.awesome-markers.min.js' %}"></script>
  <script src="{% static 'mapApp/js/map.js' %}"></script>
  <script src="{% static 'mapApp/js/icons.js' %}"></script>

  <script>
    var collisions = {{ collisions|geojsonfeature:"report_date,date,p_type,i_type"|safe}}['features'];
    var nearmisses = {{ nearmisses|geojsonfeature:"report_date,date,p_type,i_type"|safe}}['features'];
    var hazards = {{ hazards|geojsonfeature:"report_date,date,p_type,i_type"|safe}}['features'];
    var thefts = {{ thefts|geojsonfeature:"report_date,date,p_type,i_type"|safe}}['features'];

    var data = collisions.concat(nearmisses).concat(hazards).concat(thefts);


    // map p_types of points to nice labels
    var labels = {
      "collision": "Collisions",
      "nearmiss": "Nearmisses",
      "hazard": "Hazards",
      "theft": "Thefts",
    }
    // Define scales
    // map p_type to appropriate colors
    var colorScale = d3.scale.ordinal()
      .domain(["collision", "nearmiss", "hazard", "theft"])
      .range([iconColors.collision, iconColors.nearmiss, iconColors.hazard, iconColors.theft]);

    var weekdayScale = d3.scale.quantize()
        .domain([0,1,2,3,4,5,6])
        .range(moment.weekdays());

    // Define charts
    var pieTypes = dc.pieChart("#pieTypes");
    var barWeek = dc.barChart("#barWeek");
    var barDate = dc.barChart("#barDate");
    var delayRows = dc.rowChart("#delayRows");

    // Define crossfilter dataset
    var xf = crossfilter(data);

    // Define dimensions
    var p_typeDimension = xf.dimension(function(d) {return d.properties.p_type;}),
        weekdayDimension = xf.dimension(function(d) {return (moment(d.properties.date).weekday()+6)%7 }),
        dateDimension = xf.dimension(function(d){ return moment(d.properties.date).diff(moment(), "days"); }),
        i_typeDimension = xf.dimension(function(d){ return d.properties.i_type });

    // Define groups
    // Reusable reduce function for counting different types of reports
    function reduceAddTypeCount() {
      return function(p,v){
        var p_type = v.properties.p_type;
        if(p_type === "collision") p.collision++;
        else if(p_type === "nearmiss") p.nearmiss++;
        else if(p_type === "hazard") p.hazard++;
        else if(p_type === "theft") p.theft++;
        return p;
      };
    };
    function reduceRemoveTypeCount() {
      return function(p,v){
        var p_type = v.properties.p_type;
        if(p_type === "collision") p.collision--;
        else if(p_type === "nearmiss") p.nearmiss--;
        else if(p_type === "hazard") p.hazard--;
        else if(p_type === "theft") p.theft--;
        return p;
      };
    };
    function reduceInitTypeCount() {
      return function(){
        return {
          collision: 0,
          nearmiss: 0,
          hazard: 0,
          theft: 0
        };
      };
    }

    var countTypes = p_typeDimension.group().reduceCount(),
        weekdayCount = weekdayDimension.group().reduce(reduceAddTypeCount(), reduceRemoveTypeCount(), reduceInitTypeCount()),
        countPerDay = dateDimension.group().reduceCount(),
        aveDelayGroup = i_typeDimension.group().reduce(
          function(p,v) {
            ++p.count
            p.sum += moment(v.properties.report_date).diff(moment(v.properties.date), "days");
            p.avg = (p.count !== 0 ? p.sum/p.count : 0);
            p.p_type = v.properties.p_type;
            return p;
          },
          function(p,v) {
            --p.count
            p.sum -= moment(v.properties.report_date).diff(moment(v.properties.date), "days");
            p.avg = (p.count !== 0 ? p.sum/p.count : 0);
            return p;
          },
          function(){
            return {count:0, sum:0, avg:0, p_type:""};
          }
        );

    // Pie chart for number of each type of report
    pieTypes
      .width(300)
      .height(300)
      // .innerRadius(50)
      .dimension(p_typeDimension)
      .group(countTypes)
      .ordering(function(d){ return -d.value })
      .label(function(d){return labels[d.data.key];})
      .colors(colorScale.range())
      .colorAccessor(function(d){return colorScale.domain().indexOf(d.data.key);});
    pieTypes.render();

    // Bar chart for reports this week
    barWeek
      .width(700)
      .height(300)
      .x(d3.scale.linear().domain([-0.5,6.5]))
      .yAxisLabel("Count")
      .centerBar(true)
      .elasticY(true)
      .dimension(weekdayDimension)
      .group(weekdayCount, "Collisions").valueAccessor(function(d){return d.value.collision; })
      .stack(weekdayCount, "Nearmisses", function(d){ return d.value.nearmiss; })
      .stack(weekdayCount, "Hazards", function(d){ return d.value.hazard; })
      .stack(weekdayCount, "Thefts", function(d){ return d.value.theft; })
      .brushOn(true)
      .colors(colorScale.range())
      .colorAccessor(function(d){return d.layer;});
    barWeek.yAxis().tickFormat(d3.format("d"));
    barWeek.xAxis().tickValues([0,1,2,3,4,5,6]);
    barWeek.xAxis().tickFormat(function(v){ return weekdayScale((v+1)%7); });
    barWeek.render();

    // bar chart of total reports per day
    barDate
      .width(1000)
      .height(175)
      .x(d3.scale.linear().domain([-360, 0]))
      .yAxisLabel("Count")
      .centerBar(true)
      .elasticY(true)
      .dimension(dateDimension)
      .group(countPerDay)
      .brushOn(true);
    barDate.yAxis().tickFormat(d3.format("d"));
    barDate.xAxis().tickFormat(function(v){ return moment().add(v, "days").format("MMM. D"); });
    // barDate.xAxis().tickValues(); //TODO make first of each month?
    barDate.render();

    // bar chart of delay in reporting
    delayRows
      .width(500)
      .height(400)
      .dimension(i_typeDimension).keyAccessor(function(d){ return d.key; })
      .group(aveDelayGroup).valueAccessor(function(d){ return d.value.avg; })
      .ordering(function(d){ return -d.value.avg })
      .elasticX(true)
      .renderLabel(false)
      .colors(colorScale.range())
      .colorAccessor(function(d){ return colorScale.domain().indexOf(d.value.p_type); });
    delayRows.render();


    // Leaflet heatmap
    var heatLayer = new HeatmapOverlay({
      "radius": 25,
      "maxOpacity": .5,
      // "scaleRadius": true,
      "useLocalExtrema": false,
      latField: 'lat',
      lngField: 'lng',
      valueField: 'count'
    });

    var map = L.map('map', {
      center: [48.427, -123.33],
      zoom: 13,
      scrollWheelZoom: false,
      worldCopyJump: true,
      layers: [MapQuestOpen_OSM, heatLayer]
    });

    // Add crossfilter data to map
    var point_data, lat, lng;
    changeMap();
    function changeMap(){
      point_data = {
        max: 8,
        data: []
      };
      p_typeDimension.top(Infinity).forEach(function(feature){
        lng = feature.geometry.coordinates[0];
        lat = feature.geometry.coordinates[1];
        point_data.data.push({
          lat: lat,
          lng: lng,
          count: 1
        });
      });
      heatLayer.setData(point_data);
    };

    // Event triggers for any filtering action to apply to map as well
    pieTypes.on("filtered", function(chart, filter){
      changeMap();
    });
    barWeek.on("filtered", function(chart, filter){
      changeMap();
    });
    barDate.on("filtered", function(chart, filter){
      changeMap();
    });
    delayRows.on("filtered", function(chart, filter){
      changeMap();
    });


    // TODO
    // Change pie to bar chart
    // Reorganize bootstrap grid layout
    //
    // Edit title popup of delay chart
    // Calc standard dev for delay chart and provide
    // Add labels for delay chart
    // Create new js file for dc script

    dc.renderAll();
    dc.redrawAll();
  </script>

{% endblock %}
